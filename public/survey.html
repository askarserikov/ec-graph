<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Real-time Energy Consumption</title>
    <link rel="stylesheet" href="stylesheet.css" type="text/css">
</head>
<body>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<div id="pane" class="pure-g">
    <div id="welcome-msg" class="pure-u-1-3">
        <p id="welcome-text">Welcome to the survey!</p>
        <div id="welcome-form-wrapper">
            <form id="welcome-form" class="pure-form pure-form-aligned">
                <fieldset>

                    <label for="age">Your Age Group: </label>
                    <select id="age">
                        <option>0-12</option>
                        <option>13-17</option>
                        <option>18-24</option>
                        <option>25-34</option>
                        <option>35-44</option>
                        <option>45-54</option>
                        <option>65-74</option>
                        <option>74+</option>
                    </select>

                    <br><br>

                    <label for="sex">Your Sex: </label>
                    <select id="sex">
                        <option>Male</option>
                        <option>Female</option>
                        <option>Prefer not to disclose</option>
                    </select>

                    <br><br>

                    <button type="submit" class="pure-button pure-button-primary">Start</button>

                </fieldset>
            </form>
        </div>
    </div>
    <div id="bye" class="pure-u-1">
        <h3>Thank you for your time! Take care!</h3>
        <p>(You can close the tab now)</p>
    </div>
    <div id="finish-msg" class="pure-u-1">
        <p id="finish-text">Thank you for taking the survey!</p>
        <button class="pure-button pure-button-primary" id="finish-btn">Submit</button>
    </div>
    <div id="main" class="pure-u-1">
        <div class="pure-u-18-24" id="main-title"><h3 id="main-title-text">Question 1</h3></div>
        <div class="pure-u-18-24" id="container"></div>
        <div class="pure-u-18-24" id="circle-div">
            <div class="circle"></div>
        </div>
        <div id="nav-bar" class="pure-u-1">
            Evaluate the energy consumption pattern on a scale from 1 to 5<br>
            Where 1 - very inefficient and 5 - very efficient<br>
            <form id="options" class="pure-form">
                <h3 id="slider-value">1</h3>
                <input type="range" min="1" max="5" value="1" id="slider" oninput="slider_update()" style="margin-bottom: 1em">
            </form>
           <button id="next-btn" class="pure-button pure-button-primary">Next</button>
        </div>
    </div>
</div>
<script>

  var slider_val = 0;

  $(function() {
    // Handler for .ready() called.

    var ticks_number = -24,
      updateInterval = 500,
      values = [
        [1.68, 1.32, 1.6 , 1.44, 1.24, 0.95, 0.88, 1.81, 1.41, 2.8 , 1.59,
          1.77, 1.24, 1.07, 1.09, 1.54, 1.12, 1.13, 2.55, 1.79, 1.46, 1.8 ,
          1.38, 1.24],
        [2.06, 3.88, 2.84, 2.16, 1.99, 2.36, 2.2 , 2.26, 2.23, 2.25, 2.57,
          2.66, 2.77, 2.86, 3.83, 1.49, 1.18, 1.45, 1.47, 1.73, 2.35, 2.26,
          1.92, 2.15],
        [5.05, 4.04, 3.71, 3.65, 3.78, 3.51, 3.5 , 3.61, 3.56, 3.78, 3.92,
          3.92, 3.51, 3.82, 4.37, 4.33, 5.38, 4.45, 3.78, 3.77, 3.77, 3.38,
          3.69, 3.32],
        [2.04, 1.85, 1.42, 1.43, 1.43, 1.34, 1.25, 1.14, 1.66, 1.51, 2.1, 1.54,
         1.55, 1.50, 1.30, 1.16, 1.34, 1.23, 1.26, 2.02, 1.70, 1.41, 1.62, 1.41],
        [1.52, 1.77, 2.82, 1.99, 1.72, 1.68, 1.97, 1.74, 1.64, 1.73, 1.7, 2.01,
         2.18, 2.09, 1.98, 2.79, 1.5, 1.18, 1.6, 1.57, 1.57, 1.88, 1.78, 1.72],
        [4.93, 4.57, 3.76, 3.64, 3.64, 3.60, 3.58, 3.52, 3.63, 3.81, 4.23, 3.98,
         3.83, 3.77, 3.98, 4.41, 4.16, 4.65, 4.53, 4.13, 3.95, 3.92, 3.61, 3.85]
      ],
      question = 0,
      responses = {};

    $('#welcome-form').submit(function(e) {
      e.preventDefault();
      // get all the inputs into an array.
      var inputs = $('#welcome-form :input');
      responses["age"] = inputs[0]['value'];
      responses["sex"] = inputs[1]['value'];
      $("#welcome-msg").remove();
      $("#main").css('display', 'block');
      render_chart();
    });

    $("#finish-btn").click(function () {
      console.log(responses);
      $.ajax({
        type: "POST",
        url: "/response",
        dataType: "json",
        contentType: "application/json",
        processData: false,
        data: JSON.stringify(responses),
        failure: function(errMsg){console.log("Error: " + errMsg)},
        success: function(data){console.log(data);}
      });
      $("#finish-msg").remove();
      $("#bye").css('display', 'block');
    });

    $("#next-btn").click(function () {

      responses["Q" + (question + 1)] = $('#slider').val();

      uncheck_rb();
      question += 1;
      $("#main-title-text").text("Question " + (question+1));
      switch (question) {
        case 1:
        case 2:
          render_chart();
          break;
        case 3:
          $("#container").remove();
          $("#circle-div").css('display', 'block');
          render_circle();
          break;
        case 4:
        case 5:
          render_circle();
          break;
        case 6:
          $("#main").remove();
          $("#finish-msg").css('display', 'block');
          break;
        default:
      }
    });

    function render_chart() {
      $("#next-btn").attr("disabled", true);
      Highcharts.chart('container', {
        chart: {
          type: 'line',
          animation: Highcharts.svg, // don't animate in old IE
          marginRight: 10,
          events: {
            load: function () {
              var series = this.series[0];
              var j = 0;
              var IntervalId = setInterval(function () {
                var y = values[question][j];
                series.addPoint(y, true, true);
                j = j + 1;
                if (j == values[question].length) {
                  clearInterval(IntervalId);
                  $("#next-btn").attr("disabled", false);
                }
              }, updateInterval);
            }
          }
        },

        title: {
          text: 'Real-time Energy Consumption'
        },
        xAxis: {
          title: {
            text: 'Hour'
          },
          min: 0,
          max: 23,
          tickInterval: 1
        },
        yAxis: {
          title: {
            text: 'kWh'
          },
          labels: {
            enabled: false
          },
          plotLines: [{
            value: 0,
            width: 1,
            color: '#003c8f'
          }]
        },
        tooltip: {
          headerFormat: '<b>{series.name}</b><br/>',
          pointFormat: ''
        },
        legend: {
          enabled: false
        },
        exporting: {
          enabled: false
        },
        series: [{
          name: 'Energy consumption',
          color: '#003c8f',
          data: (function () {
            // generate an array of random data
            var data = [], i;

            for (i = ticks_number; i <= 0; i += 1) {
              data.push({
                x: null,
                y: null
              });
            }
            return data;
          }())
        }]
      });

    }

    function render_circle(){
      $("#next-btn").attr("disabled", true);
      var j = 0;
      var IntervalId = setInterval(function () {
        var actual = values[question-3][j];
        var predicted = values[question][j];

        if (predicted * 0.9 <= actual && predicted * 1.1 > actual) {
          $(".circle").css('background-color', '#FFF200')
            .text(j + ":00");
        }
        else if (predicted * 1.1 <= actual && predicted * 1.25 > actual) {
          $(".circle").css('background-color', '#FF9E0F')
            .text(j + ":00");
        }
        else if (predicted * 1.25 <= actual && actual < predicted * 1.5) {
          $(".circle").css('background-color', '#FF430B')
            .text(j + ":00");
        }
        else if (predicted * 1.5 <= actual) {
          $(".circle").css('background-color', '#FF0000')
            .text(j + ":00");
        }
        else if (predicted * 0.75 <= actual && predicted * 0.9 > actual) {
          $(".circle").css('background-color', '#67B304')
            .text(j + ":00");
        }
        else if (actual < predicted * 0.75) {
          $(".circle").css('background-color', '#1E9600')
            .text(j + ":00");
        }

        j = j + 1;
        if (j == values[question].length) {
          clearInterval(IntervalId);
          $("#next-btn").attr("disabled", false);
        }
      }, updateInterval);
    }

    function uncheck_rb() {
      //$("#options input[type=radio]").prop('checked',false);
      $("#slider").val(0);
      slider_update();
    }

  });

  function slider_update() {
    $("#slider-value").text($("#slider").val());
  };

</script>
</body>
</html>